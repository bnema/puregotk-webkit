package main

import (
	"os"
	"path/filepath"
	"strings"
	"text/template"

	"github.com/jwijenbergh/puregotk/pkg/gir/pass"
	"github.com/jwijenbergh/puregotk/pkg/gir/util"
)

//go:generate go run gen.go

// Namespaces to generate (others are for type resolution only)
var localNamespaces = map[string]bool{
	"WebKit":                    true,
	"JavaScriptCore":            true,
	"WebKitWebProcessExtension": true,
	"Soup":                      true,
}

func main() {
	dir := "."
	// Clean up previously generated packages
	for ns := range localNamespaces {
		os.RemoveAll(strings.ToLower(ns))
	}

	var girs []string
	filepath.Walk("internal/gir/spec", func(path string, f os.FileInfo, err error) error {
		if !strings.HasSuffix(path, ".gir") {
			return nil
		}
		girs = append(girs, path)
		return nil
	})

	p, err := pass.New(girs)
	if err != nil {
		panic(err)
	}

	// Collect ALL types for resolution (including base GTK types)
	p.First()

	// Filter to only generate WebKit namespaces
	var filtered []pass.Repository
	for _, r := range p.Parsed {
		ns := r.Namespaces[0].Name
		if localNamespaces[ns] {
			filtered = append(filtered, r)
		}
	}
	p.Parsed = filtered

	// Create the template
	gotemp, err := template.New("go").Funcs(template.FuncMap{
		"conv":     util.ConvertArgs,
		"convc":    util.ConvertArgsComma,
		"convcb":   util.ConvertCallbackArgs,
		"convcd":   util.ConvertArgsCommaDeref,
		"convd":    util.ConvertArgsDeref,
		"convcbne": util.ConvertCallbackArgsNoErr,
		"propsset": util.PropertyScalarSet,
		"propsget": util.PropertyScalarGet,
		"propvset": util.PropertyVectorSet,
		"propvget": util.PropertyVectorGet,
	}).ParseFiles("templates/go")
	if err != nil {
		panic(err)
	}

	// Write go files by making the second pass
	p.Second(dir, gotemp)

	if err := writeWebViewExtras(dir); err != nil {
		panic(err)
	}
}

// writeWebViewExtras adds manually-crafted APIs that are not present in the GIR
// but are available via construct-only properties (e.g. related-view).
func writeWebViewExtras(dir string) error {
	const webViewExtras = `// Code generated by puregotk-webkit extras; DO NOT EDIT.
package webkit

import "github.com/jwijenbergh/puregotk/v4/gobject"

// NewWebViewWithRelatedView creates a new WebView that shares the same
// WebContext and NetworkSession as the provided related view. This is required
// for popup windows (window.open/target=_blank) to share cookies/session data.
func NewWebViewWithRelatedView(relatedView *WebView) *WebView {
	if relatedView == nil {
		return NewWebView()
	}

	var relatedValue gobject.Value
	relatedValue.Init(WebViewGLibType())
	parentObj := gobject.Object{Ptr: relatedView.GoPointer()}
	relatedValue.SetObject(&parentObj)

	obj := gobject.NewObjectWithProperties(
		WebViewGLibType(),
		1,
		[]string{"related-view"},
		[]gobject.Value{relatedValue},
	)
	if obj == nil {
		return nil
	}

	gobject.IncreaseRef(obj.GoPointer())

	view := &WebView{}
	view.Ptr = obj.Ptr
	return view
}
`
	webkitDir := filepath.Join(dir, "webkit")
	if err := os.MkdirAll(webkitDir, 0o755); err != nil {
		return err
	}
	path := filepath.Join(webkitDir, "WebKitWebViewExtras.go")
	return os.WriteFile(path, []byte(webViewExtras), 0o644)
}
